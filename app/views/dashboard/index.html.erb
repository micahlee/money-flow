<h1>Finance Outlook</h1>

<%= link_to 'Sync All', sync_all_connections_path,
              method: :post,
              data: { confirm: 'Are you sure?' } %> |
<%= link_to 'Bank Connections', connections_path %> |
<%= link_to 'Funds', funds_path %> |
<%= link_to "Money Mover", money_mover_path(cycle: 1) %>

<h2>Transaction Inbox</h2>
<%= link_to "Download", dashboard_path(format: 'csv') %>
<table class="table">
<thead>
<tr>
<th></th>
<th>Assign</th>
<th>Date</th>
<th>Account</th>
<th>Name</th>
<th>Amount</th>
</tr>
</thead>
<tbody>
  <% @transactions.each do |t| %>
    <tr>
    <td>
        <button 
          type="button" 
          class="btn btn-light" 
          onclick="clearTransaction(this, <%=t.account.connection.id%>, <%=t.account.id%>, <%=t.id%>)">
          Clear
        </button>
      </td>
      <td>
        <select onchange="assignTransaction(this, <%=t.account.connection.id%>, <%=t.account.id%>, <%=t.id%>)">
          <option>Assign</option>
          <% @funds.each do |fund| %>
            <option value="<%=fund.id%>"><%=fund.name%></option>
          <% end %>
        </select>
        <br />
        <%= link_to 'Split', split_connection_account_transaction_path(t.account.connection, t.account, t), class: 'btn btn-link'%>
      </td>
      <td><%=t.date%></td>
      
      <td>
        <%=t.account.name%><br />
        <%=t.account.connection.name%>
        </td>
            <td><%=t.name%></td>
<td>
        <%=number_to_currency(t.amount * -1)%><br/>
        <%= 'pending' if t.pending %>
      </td>
      
    </tr>
  <% end %>
</tbody>
</table>

<h2>Account Snapshot</h2>
<table class="table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Cash</th>
      <th>Credit</th>
      <th>Uncleared</th>
      <th>Available</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <strong>Total:</strong>
      </td>
      <td style="font-weight: bold;"><%=number_to_currency(@accounts.map(&:cash_amount).compact.sum)%></td>
      <td style="font-weight: bold;"><%=number_to_currency(@accounts.map(&:credit_amount).compact.sum)%></td>
      <td style="font-weight: bold;"><%=number_to_currency(@accounts.map(&:uncleared_amount).compact.sum)%></td>
      <td style="font-weight: bold;"><%=number_to_currency(@accounts.map(&:available_amount).compact.sum)%></td>

    </tr>
    <% @accounts.each do |a| %>
      <tr>
        <td>
          <% unless a.sync_ok? %>
            <span class="oi oi-warning text-danger" title="person" aria-hidden="true"></span>
          <% end %>
          <%=link_to a.name, connection_account_path(a.connection, a) %> <br/>
          <%=a.connection.name%><br/>
          <%=a.account_type%> - <%=a.account_subtype%>
        </td>
        <td><%=number_to_currency(a.cash_amount)%></td>
        <td><%=number_to_currency(a.credit_amount)%></td>
        <td><%=number_to_currency(a.uncleared_amount) if a.uncleared_amount%></td>
        <td><%=number_to_currency(a.available_amount) if a.available_amount%></td>

      </tr>
    <% end %>
  </tbody>
</table>



<script>
(function($) {
  function clearTransaction(button, connectionId, accountId, transactionId) {
    $(button).attr('disabled', true);
    $.ajax({
      url: '/connections/' + connectionId + '/accounts/' + accountId + '/transactions/' + transactionId + '/clear',
      type: 'post',
      data: {},
      headers: {
        'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
      },
      success: function(data) {
        $(button).closest('tr').hide('fast');
      }
    });
  }

  function assignTransaction(select, connectionId, accountId, transactionId) {
    $(select).attr('disabled', true);
    let fundId = $(select).val();
    $.ajax({
      url: '/connections/' + connectionId + '/accounts/' + accountId + '/transactions/' + transactionId + '/assign?fund_id=' + fundId,
      type: 'post',
      data: {},
      headers: {
        'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
      },
      success: function(data) {
        $(select).closest('tr').hide('fast');
      }
    });
  }

  window.clearTransaction = clearTransaction;
  window.assignTransaction = assignTransaction;
})(jQuery);
</script>
